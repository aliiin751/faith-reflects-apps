import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, 
  Trash2, 
  Sun, 
  CloudSun,
  Moon,
  Battery, 
  BatteryLow, 
  BatteryMedium, 
  Coffee, 
  CheckCircle2, 
  X, 
  RefreshCw, 
  BookOpen, 
  Sparkles,
  Quote,
  Lock,
  Unlock,
  Check,
  Gift,
  Feather
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  query, 
  onSnapshot, 
  serverTimestamp, 
  writeBatch,
  setDoc
} from 'firebase/firestore';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'faith-reflects-planner';

// --- Constants ---
const BIBLICAL_AFFIRMATIONS = [
  "His mercies are new every morning.",
  "Be still, and know that I am God.",
  "My grace is sufficient for you.",
  "The joy of the Lord is your strength.",
  "Come to me, all who are weary.",
  "He restores my soul."
];

const REWARD_OPTIONS = ["â˜• Coffee Break", "ðŸŒ³ Nature Walk", "ðŸ“± Call a Friend", "ðŸ’¤ Power Nap"];

// SVG Noise Texture for Paper Effect
const NOISE_TEXTURE = `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E")`;

// --- Components ---

// 1. Energy Badge Component (Refined)
const EnergyBadge = ({ level }) => {
  const styles = {
    low: { bg: 'bg-emerald-50 border-emerald-200', text: 'text-emerald-700', icon: BatteryLow, label: 'Grace Mode' },
    medium: { bg: 'bg-amber-50 border-amber-200', text: 'text-amber-700', icon: BatteryMedium, label: 'Steady' },
    high: { bg: 'bg-rose-50 border-rose-200', text: 'text-rose-700', icon: Battery, label: 'Focus' },
  };

  const current = styles[level] || styles.medium;
  const Icon = current.icon;

  return (
    <span className={`flex items-center gap-1 px-2 py-0.5 rounded-md border text-[10px] uppercase tracking-wider font-semibold ${current.bg} ${current.text}`}>
      <Icon size={10} />
      {current.label}
    </span>
  );
};

// 2. Task Item Component (More Editorial)
const TaskItem = ({ task, onToggle, onDelete, index }) => {
  return (
    <div 
      className={`group relative flex items-center justify-between p-4 mb-3 rounded-xl transition-all duration-500 border animate-in slide-in-from-bottom-2 fade-in fill-mode-forwards 
      ${task.completed 
        ? 'bg-stone-50/40 border-stone-100/50 grayscale opacity-70' 
        : 'bg-white/70 backdrop-blur-sm border-white/50 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] hover:shadow-md hover:scale-[1.005] hover:bg-white/90'}`}
      style={{ animationDelay: `${index * 50}ms` }}
    >
      <div className="flex items-center gap-4 flex-1">
        <button 
          onClick={() => onToggle(task.id, !task.completed)}
          className={`relative flex-shrink-0 w-5 h-5 rounded-full border flex items-center justify-center transition-all duration-300 
          ${task.completed 
            ? 'bg-stone-400 border-stone-400 scale-100' 
            : 'bg-stone-50 border-stone-300 hover:border-amber-400 hover:bg-white'}`}
        >
          {task.completed && <CheckCircle2 size={12} className="text-white animate-in zoom-in duration-200" />}
        </button>
        
        <div className="flex flex-col gap-1.5 w-full">
            <span className={`text-base tracking-tight font-medium transition-all duration-300 ${task.completed ? 'text-stone-400 line-through decoration-stone-300 translate-x-1' : 'text-stone-700'}`}>
              {task.text}
            </span>
            {!task.completed && <div className="flex opacity-80 group-hover:opacity-100 transition-opacity"><EnergyBadge level={task.energy} /></div>}
        </div>
      </div>
      
      <button 
        onClick={() => onDelete(task.id)}
        className="opacity-0 group-hover:opacity-100 p-2 text-stone-300 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all duration-200 transform scale-90 group-hover:scale-100"
      >
        <Trash2 size={15} />
      </button>
    </div>
  );
};

// 3. Progress Visual (Slimmer, more elegant)
const ProgressHeader = ({ percentage }) => {
    return (
        <div className="mb-10 animate-in fade-in slide-in-from-top-4 duration-1000">
            <div className="flex justify-between items-end text-xs font-medium text-stone-400 uppercase tracking-[0.15em] mb-3">
                <span className="flex items-center gap-2">
                   {percentage === 100 ? <Sparkles size={12} className="text-amber-400 animate-spin-slow" /> : null}
                   Daily Stewardship
                </span>
                <span className={`font-serif text-sm ${percentage === 100 ? "text-amber-600 font-bold" : "text-stone-500"}`}>{Math.round(percentage)}%</span>
            </div>
            <div className="h-1.5 w-full bg-stone-200/30 rounded-full overflow-hidden">
                <div 
                    className={`h-full transition-all duration-1000 ease-out rounded-full shadow-[0_0_10px_rgba(251,191,36,0.3)] 
                    ${percentage === 100 
                        ? 'bg-gradient-to-r from-amber-200 via-yellow-300 to-amber-200 animate-pulse' 
                        : 'bg-gradient-to-r from-stone-300 via-stone-400 to-stone-300'}`}
                    style={{ width: `${percentage}%` }}
                />
            </div>
        </div>
    );
}

// --- Main Application Component ---
export default function App() {
  const [user, setUser] = useState(null);
  const [tasks, setTasks] = useState([]);
  const [usedRewards, setUsedRewards] = useState([]);
  const [brainDump, setBrainDump] = useState("");
  const [newTaskText, setNewTaskText] = useState("");
  const [newTaskEnergy, setNewTaskEnergy] = useState("medium");
  const [activeTab, setActiveTab] = useState("today"); 
  const [isResetting, setIsResetting] = useState(false);
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  const [showConfetti, setShowConfetti] = useState(false);
  const [quote, setQuote] = useState(BIBLICAL_AFFIRMATIONS[0]);
  const [greeting, setGreeting] = useState({ text: "Good Morning", icon: Sun });

  // --- Calculated State ---
  const completionPercentage = useMemo(() => {
    if (tasks.length === 0) return 0;
    const completed = tasks.filter(t => t.completed).length;
    return (completed / tasks.length) * 100;
  }, [tasks]);

  const completedCount = tasks.filter(t => t.completed).length;
  const claimedCount = usedRewards.length;
  const availableCredits = Math.max(0, completedCount - claimedCount);
  const allRewardsClaimed = claimedCount >= REWARD_OPTIONS.length;
  const isRewardSelectionUnlocked = availableCredits > 0 && !allRewardsClaimed;

  // Time-based Greeting
  useEffect(() => {
    const hour = new Date().getHours();
    if (hour < 12) setGreeting({ text: "Good Morning", icon: Sun });
    else if (hour < 18) setGreeting({ text: "Good Afternoon", icon: CloudSun });
    else setGreeting({ text: "Good Evening", icon: Moon });

    setQuote(BIBLICAL_AFFIRMATIONS[Math.floor(Math.random() * BIBLICAL_AFFIRMATIONS.length)]);
  }, []);

  // Authentication Setup
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Data Syncing
  useEffect(() => {
    if (!user) return;

    // Tasks Listener
    const tasksQuery = query(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'));
    const unsubTasks = onSnapshot(tasksQuery, (snapshot) => {
      const loadedTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      loadedTasks.sort((a, b) => {
        if (a.completed === b.completed) return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
        return a.completed ? 1 : -1;
      });
      setTasks(loadedTasks);
    }, (error) => console.error("Tasks sync error:", error));

    // Brain Dump & Daily State Listener
    const notesQuery = query(collection(db, 'artifacts', appId, 'users', user.uid, 'data'));
    const unsubNotes = onSnapshot(notesQuery, (snapshot) => {
        snapshot.docs.forEach(doc => {
            if (doc.id === 'braindump') setBrainDump(doc.data().content || "");
            if (doc.id === 'dailyState') setUsedRewards(doc.data().usedRewards || []);
        });
    }, (error) => console.error("Data sync error:", error));

    return () => {
      unsubTasks();
      unsubNotes();
    };
  }, [user]);

  // Handlers
  const handleAddTask = async (e) => {
    e.preventDefault();
    if (!newTaskText.trim() || !user) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'), {
        text: newTaskText,
        energy: newTaskEnergy,
        completed: false,
        createdAt: serverTimestamp(),
        type: 'task' 
      });
      setNewTaskText("");
    } catch (err) {
      console.error("Error adding task:", err);
    }
  };

  const handleToggleTask = async (id, status) => {
    if (!user) return;
    const taskRef = doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', id);
    await updateDoc(taskRef, { completed: status });
    if (status) triggerConfetti();
  };

  const handleDeleteTask = async (id) => {
    if (!user) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', id));
  };

  const handleBrainDumpChange = async (e) => {
    setBrainDump(e.target.value);
  };

  const handleBrainDumpBlur = async () => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'braindump');
    await setDoc(docRef, { content: brainDump }, { merge: true });
  };

  const triggerConfetti = () => {
    setShowConfetti(true);
    setTimeout(() => setShowConfetti(false), 2000);
  };

  const handleClaimReward = async (rewardName) => {
    if (!user || !isRewardSelectionUnlocked || usedRewards.includes(rewardName)) return;
    const newUsed = [...usedRewards, rewardName];
    setUsedRewards(newUsed); 
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'dailyState');
    await setDoc(docRef, { usedRewards: newUsed }, { merge: true });
  };

  const executeNewMercies = async () => {
    if (!user) return;
    setIsResetting(true);
    setShowResetConfirm(false);
    try {
      const batch = writeBatch(db);
      const completed = tasks.filter(t => t.completed);
      completed.forEach(task => {
        const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'tasks', task.id);
        batch.delete(ref);
      });
      const dailyStateRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'dailyState');
      batch.set(dailyStateRef, { usedRewards: [] }, { merge: true });
      await batch.commit();
      triggerConfetti();
    } catch (err) {
      console.error("Reset failed", err);
    } finally {
      setIsResetting(false);
    }
  };

  const quickAddDopamine = async (text, energy) => {
    if (!user) return;
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'tasks'), {
      text: text,
      energy: energy,
      completed: false,
      createdAt: serverTimestamp(),
      type: 'task'
    });
    setActiveTab('today');
  };

  // --- Render ---
  const GreetingIcon = greeting.icon;

  return (
    <div className={`min-h-screen transition-all duration-1000 ${isRewardSelectionUnlocked ? 'bg-[#FFFBF2]' : 'bg-[#FDFCF8]'} text-stone-800 font-sans selection:bg-amber-100 overflow-x-hidden relative`}>
      
      {/* Noise Texture Overlay */}
      <div 
        className="fixed inset-0 pointer-events-none z-[1] opacity-60 mix-blend-multiply"
        style={{ backgroundImage: NOISE_TEXTURE }}
      />

      {/* Dynamic Background Gradients */}
      <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div className={`absolute -top-[20%] -left-[10%] w-[60%] h-[60%] rounded-full mix-blend-multiply filter blur-[120px] opacity-30 animate-blob transition-colors duration-1000 ${isRewardSelectionUnlocked ? 'bg-amber-200' : 'bg-stone-200'}`}></div>
        <div className={`absolute top-[10%] -right-[10%] w-[50%] h-[50%] rounded-full mix-blend-multiply filter blur-[100px] opacity-20 animate-blob animation-delay-2000 transition-colors duration-1000 ${isRewardSelectionUnlocked ? 'bg-orange-100' : 'bg-emerald-50'}`}></div>
        <div className={`absolute -bottom-[20%] left-[20%] w-[50%] h-[50%] rounded-full mix-blend-multiply filter blur-[100px] opacity-20 animate-blob animation-delay-4000 transition-colors duration-1000 ${isRewardSelectionUnlocked ? 'bg-yellow-100' : 'bg-amber-50'}`}></div>
      </div>

      <div className="relative z-10 flex flex-col min-h-screen">
      
        {/* Visual Header */}
        <header className="px-6 py-12 max-w-2xl mx-auto w-full">
            <div className="flex items-start justify-between mb-8">
            <div>
                <div className="flex items-center gap-2 text-amber-600/80 mb-3 animate-in slide-in-from-top-2 duration-700">
                    <GreetingIcon size={16} />
                    <span className="text-[10px] font-bold tracking-[0.2em] uppercase">{greeting.text}, Steward</span>
                </div>
                <h1 className="text-4xl md:text-5xl font-serif font-medium text-stone-800 mb-3 tracking-tight leading-tight">
                Grace & <br/><span className="italic text-stone-600">Stewardship</span>
                </h1>
                <div className="flex items-center gap-2 text-stone-400 text-xs mt-4 pl-1 border-l-2 border-amber-100/50">
                    <Quote size={10} className="text-amber-300" />
                    <span className="font-serif italic opacity-80">"{quote}"</span>
                </div>
            </div>
            
            <button 
                onClick={() => setShowResetConfirm(true)}
                disabled={isResetting}
                className="group flex flex-col items-center justify-center w-14 h-14 bg-white/60 backdrop-blur-sm border border-stone-200 rounded-full shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] hover:shadow-lg hover:border-amber-200 hover:scale-105 transition-all duration-300"
                title="New Mercies (Reset)"
            >
                <RefreshCw size={18} className={`text-stone-400 group-hover:text-amber-500 transition-colors ${isResetting ? "animate-spin" : ""}`} />
            </button>
            </div>

            <ProgressHeader percentage={completionPercentage} />
        </header>

        {/* Main Content Grid */}
        <main className="max-w-2xl mx-auto px-6 pb-12 w-full flex-grow">
            
            {/* Navigation Tabs (Minimalist) */}
            <div className="flex gap-8 border-b border-stone-200/40 mb-10">
            <button 
                onClick={() => setActiveTab('today')}
                className={`pb-3 text-sm font-semibold tracking-wide transition-all relative ${activeTab === 'today' ? 'text-stone-800' : 'text-stone-400 hover:text-stone-600'}`}
            >
                My Stewardship
                {activeTab === 'today' && <span className="absolute bottom-0 left-1/2 -translate-x-1/2 w-4 h-0.5 bg-stone-800 rounded-full transition-all duration-300"></span>}
            </button>
            <button 
                onClick={() => setActiveTab('menu')}
                className={`pb-3 text-sm font-semibold tracking-wide transition-all relative ${activeTab === 'menu' ? 'text-stone-800' : 'text-stone-400 hover:text-stone-600'}`}
            >
                Dopamine Menu
                {activeTab === 'menu' && <span className="absolute bottom-0 left-1/2 -translate-x-1/2 w-4 h-0.5 bg-stone-800 rounded-full transition-all duration-300"></span>}
            </button>
            </div>

            {activeTab === 'today' ? (
            <div className="space-y-10 animate-in fade-in zoom-in-95 duration-500">
                
                {/* Input Area (Card Style) */}
                <div className="bg-white/70 backdrop-blur-md p-3 rounded-[2rem] shadow-sm border border-stone-100 hover:shadow-md hover:border-amber-100/50 transition-all duration-300 group focus-within:ring-2 focus-within:ring-amber-50 focus-within:border-amber-200/50">
                    <form onSubmit={handleAddTask} className="flex items-center gap-2">
                        <div className="pl-4">
                            <Plus size={20} className="text-stone-300 group-focus-within:text-amber-400 transition-colors" />
                        </div>
                        <input
                            type="text"
                            value={newTaskText}
                            onChange={(e) => setNewTaskText(e.target.value)}
                            placeholder="Add a new task..."
                            className="flex-1 px-2 py-3 bg-transparent outline-none text-stone-700 placeholder:text-stone-400/70 text-lg font-medium tracking-tight"
                        />
                        <div className="flex items-center gap-2 pr-2">
                            <select 
                                value={newTaskEnergy}
                                onChange={(e) => setNewTaskEnergy(e.target.value)}
                                className="bg-stone-50 hover:bg-stone-100 transition-colors text-xs font-bold uppercase tracking-wider text-stone-500 py-2.5 px-3 rounded-xl outline-none cursor-pointer appearance-none border border-transparent hover:border-stone-200"
                            >
                                <option value="low">Grace</option>
                                <option value="medium">Steady</option>
                                <option value="high">Focus</option>
                            </select>
                            <button 
                                type="submit"
                                className="p-3 bg-stone-800 text-stone-50 rounded-xl hover:bg-stone-900 hover:scale-105 active:scale-95 transition-all shadow-lg shadow-stone-200"
                            >
                                <Check size={18} />
                            </button>
                        </div>
                    </form>
                </div>

                {/* Tasks List */}
                <div className="space-y-1 min-h-[150px]">
                {tasks.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-16 text-stone-400 animate-in fade-in duration-700">
                    <div className="relative mb-6 opacity-80">
                         <div className="absolute inset-0 bg-amber-100 rounded-full blur-2xl opacity-40"></div>
                         <Coffee size={48} className="text-stone-300 relative z-10" />
                    </div>
                    <p className="text-xl font-serif text-stone-400/80">A clean slate.</p>
                    <p className="text-[10px] uppercase tracking-[0.2em] mt-3 font-semibold text-stone-300">Rest in His Grace</p>
                    </div>
                ) : (
                    tasks.map((task, idx) => (
                    <TaskItem 
                        key={task.id} 
                        task={task} 
                        onToggle={handleToggleTask} 
                        onDelete={handleDeleteTask}
                        index={idx}
                    />
                    ))
                )}
                </div>

                {/* Brain Dump Section (Paper Style) */}
                <div className="mt-16">
                    <div className="relative group">
                        <div className="absolute -top-3 left-6 bg-[#FCFBF8] px-3 flex items-center gap-2 text-stone-400 group-focus-within:text-amber-500 transition-colors text-[10px] font-bold uppercase tracking-[0.2em] z-10 border border-stone-100 rounded-full shadow-sm">
                            <Feather size={10} />
                            Brain Dump
                        </div>
                        <textarea
                            value={brainDump}
                            onChange={handleBrainDumpChange}
                            onBlur={handleBrainDumpBlur}
                            placeholder="Unload your mind..."
                            className="w-full h-48 p-8 rounded-[2rem] bg-white/40 backdrop-blur-sm border border-stone-200/60 text-stone-700 placeholder:text-stone-300/80 focus:ring-4 focus:ring-stone-50 focus:border-amber-200/50 outline-none resize-none text-base leading-relaxed shadow-sm transition-all duration-500 bg-[url('https://www.transparenttextures.com/patterns/notebook.png')] bg-fixed"
                        />
                    </div>
                </div>

            </div>
            ) : (
            <div className="animate-in slide-in-from-bottom-4 duration-500">
                {/* Dopamine Menu View */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {/* Starters & Mains */}
                {[
                    { title: "Appetizers", icon: BatteryLow, color: "text-emerald-600", bg: "bg-emerald-100", items: ["ðŸŒ± Water Plants", "ðŸ“– Read 1 Psalm", "ðŸŽµ 1 Worship Song", "ðŸ™†â€â™€ï¸ Stretch"], type: "low" },
                    { title: "Main Course", icon: BatteryMedium, color: "text-amber-600", bg: "bg-amber-100", items: ["âœï¸ Journal 15m", "ðŸ“§ Inbox Zero", "ðŸ•¯ï¸ Bible Study", "ðŸ§¹ Clean Desk"], type: "medium" }
                ].map((section, idx) => (
                    <div key={idx} className="bg-white/60 backdrop-blur-md p-6 rounded-[2rem] border border-white/60 shadow-sm hover:shadow-lg hover:border-stone-100 transition-all duration-300 group">
                        <h3 className="flex items-center gap-3 font-serif font-bold text-lg text-stone-700 mb-6">
                            <div className={`p-2.5 rounded-xl ${section.bg} ${section.color} group-hover:scale-110 transition-transform duration-300 shadow-sm`}>
                                <section.icon size={18} />
                            </div>
                            {section.title}
                        </h3>
                        <div className="space-y-3">
                        {section.items.map((item, i) => (
                            <button 
                                key={i}
                                onClick={() => quickAddDopamine(item.substring(2), section.type)}
                                className="w-full text-left px-4 py-3 text-sm font-medium text-stone-600 bg-white/50 border border-transparent hover:border-stone-200 hover:bg-white hover:shadow-sm rounded-xl transition-all flex items-center justify-between group/btn"
                            >
                                {item}
                                <Plus size={14} className="opacity-0 -translate-x-2 group-hover/btn:opacity-100 group-hover/btn:translate-x-0 transition-all text-stone-400" />
                            </button>
                        ))}
                        </div>
                    </div>
                ))}

                {/* Desserts (Rewards) - Dynamic Credit System */}
                <div className={`md:col-span-2 relative p-8 rounded-[2.5rem] border shadow-xl transition-all duration-700 overflow-hidden 
                    ${isRewardSelectionUnlocked 
                        ? 'bg-gradient-to-br from-[#2D2A26] to-[#1C1917] border-amber-500/30 shadow-amber-900/10' 
                        : 'bg-[#2D2A26] border-[#2D2A26] shadow-2xl'}`}>
                    
                    {/* Header with Credit Status */}
                    <div className="relative z-10 flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8">
                        <h3 className="flex items-center gap-3 font-serif text-xl text-stone-200">
                            <div className={`p-2.5 rounded-xl transition-all duration-500 ${isRewardSelectionUnlocked ? 'bg-amber-500/20 text-amber-300 shadow-[0_0_15px_rgba(251,191,36,0.2)]' : 'bg-stone-800 text-stone-600'}`}>
                                {isRewardSelectionUnlocked ? <Unlock size={20} /> : <Lock size={20} />}
                            </div>
                            <span className={isRewardSelectionUnlocked ? "text-amber-50" : "text-stone-500"}>Rewards Vault</span>
                        </h3>
                        
                        {/* Status Pill */}
                        {!allRewardsClaimed && (
                            <div className={`px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-[0.1em] flex items-center gap-2 self-start sm:self-auto transition-all duration-500 
                                ${isRewardSelectionUnlocked 
                                    ? 'bg-amber-400 text-stone-900 shadow-[0_0_20px_rgba(251,191,36,0.4)] animate-pulse' 
                                    : 'bg-stone-800 text-stone-500 border border-stone-700/50'}`}>
                                {isRewardSelectionUnlocked ? (
                                    <>
                                        <Gift size={12} /> Select One Reward
                                    </>
                                ) : (
                                    <>
                                        <span>Complete a task to unlock</span>
                                    </>
                                )}
                            </div>
                        )}
                         {allRewardsClaimed && (
                            <div className="px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-wider bg-emerald-900/80 text-emerald-400 border border-emerald-800">
                                All Enjoyed!
                            </div>
                        )}
                    </div>

                    {/* Content */}
                    <div className="relative z-10">
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        {REWARD_OPTIONS.map((item, i) => {
                            const isUsed = usedRewards.includes(item);
                            const isInteractive = !isUsed && isRewardSelectionUnlocked;

                            return (
                                <button 
                                    key={i} 
                                    onClick={() => handleClaimReward(item)}
                                    disabled={!isInteractive}
                                    className={`relative p-4 h-24 rounded-2xl text-sm font-medium flex items-center justify-center text-center transition-all duration-500 border overflow-hidden group/reward
                                        ${isUsed 
                                            ? 'bg-stone-900/30 border-stone-800/50 text-stone-700 cursor-default' 
                                            : isInteractive 
                                                ? 'bg-gradient-to-br from-stone-800 to-stone-800/50 border-stone-700 hover:border-amber-500/50 hover:from-stone-800 hover:to-amber-900/20 text-stone-300 hover:text-white cursor-pointer hover:-translate-y-1 hover:shadow-xl'
                                                : 'bg-stone-800/30 border-stone-800/50 text-stone-600 cursor-not-allowed blur-[1px]'
                                        }`}
                                >
                                    {/* Shimmer Effect for Interactive Cards */}
                                    {isInteractive && (
                                        <div className="absolute inset-0 -translate-x-full group-hover/reward:animate-[shimmer_1.5s_infinite] bg-gradient-to-r from-transparent via-white/5 to-transparent"></div>
                                    )}

                                    {isUsed && (
                                        <div className="absolute inset-0 flex items-center justify-center bg-stone-950/80 z-10 backdrop-blur-[1px]">
                                            <span className="flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-wider text-emerald-400/90 bg-emerald-950/30 px-3 py-1.5 rounded-full border border-emerald-900/50">
                                                <Check size={10} /> Enjoyed
                                            </span>
                                        </div>
                                    )}
                                    <span className="relative z-0">{item}</span>
                                </button>
                            );
                        })}
                        </div>
                    </div>
                </div>

                </div>
            </div>
            )}
        </main>

        {/* Brand Footer */}
        <footer className="text-center pb-12 pt-8">
            <div className="inline-flex flex-col items-center gap-3 opacity-40 hover:opacity-100 transition-opacity duration-500 cursor-default group">
                <div className="flex items-center gap-2 text-stone-400 group-hover:text-stone-600 transition-colors">
                    <Sparkles size={12} className="text-amber-400" />
                    <span className="font-serif italic text-sm">Created by</span>
                    <span className="font-bold tracking-wide text-sm text-stone-600">@faithreflects</span>
                </div>
                <div className="w-12 h-px bg-gradient-to-r from-transparent via-stone-300 to-transparent"></div>
                <p className="text-[9px] uppercase tracking-[0.3em] text-stone-400 font-medium">Soli Deo Gloria</p>
            </div>
        </footer>
      
        {/* Reset Confirmation Modal */}
        {showResetConfirm && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/20 backdrop-blur-sm animate-in fade-in duration-300">
                <div className="bg-white/90 backdrop-blur-xl rounded-[2rem] p-8 max-w-sm w-full shadow-2xl border border-white scale-100 animate-in zoom-in-95 duration-200">
                    <div className="flex flex-col items-center text-center">
                        <div className="p-4 bg-amber-50 rounded-2xl mb-5 shadow-inner">
                            <RefreshCw size={28} className="text-amber-600" />
                        </div>
                        <h3 className="text-2xl font-serif font-medium text-stone-800 mb-3">New Mercies?</h3>
                        <p className="text-stone-500 text-sm mb-8 leading-relaxed px-2">
                            This will clear your board and reset your daily rewards, offering a fresh start for tomorrow.
                        </p>
                        <div className="flex gap-3 w-full">
                            <button 
                                onClick={() => setShowResetConfirm(false)}
                                className="flex-1 px-4 py-3.5 rounded-xl text-sm font-bold text-stone-500 hover:bg-stone-100 transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={executeNewMercies}
                                className="flex-1 px-4 py-3.5 rounded-xl text-sm font-bold text-amber-50 bg-stone-800 hover:bg-stone-900 shadow-xl shadow-stone-200 hover:scale-105 active:scale-95 transition-all"
                            >
                                Confirm Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* Confetti Animation Overlay */}
        {showConfetti && (
            <div className="fixed inset-0 pointer-events-none flex items-center justify-center z-50 animate-in fade-in duration-500">
            <div className="text-9xl animate-bounce drop-shadow-2xl">âœ¨</div>
            </div>
        )}

      </div>
    </div>
  );
}